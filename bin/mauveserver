#! /usr/bin/ruby1.8

begin
  eval "Proc.new { |a,&b| }"
rescue SyntaxError => no_blocks_with_procs
  STDERR.print "mauveserver must have Ruby 1.8.7 or later, sorry (if you "+
    "try, you'll get a SyntaxError trying to load one of its libraries)\n"
  exit 1
end
  
require 'mauve/configuration'
include Mauve

configuration_file = ARGV[0]

configuration_file = [".", "/etc/mauvealert/"].find{|d| File.file?(File.join(d,"mauveserver.conf")) } if configuration_file.nil?

configuration_file = File.expand_path(configuration_file)

unless File.file?(configuration_file)
  STDERR.print "Configuration file #{configuration_file} not found"
  Kernel.exit 1
end

Configuration.current = ConfigurationBuilder.load(configuration_file)

%w(HUP).each do |sig|
  trap("HUP") do
    # this blows up if you do it twice in quick succession, but don't really 
    # care about that case as it's only for log rotation.
    Configuration.current.logger.warn "#{sig} signal received.  Restarting."
    Configuration.current.server.stop
    #
    # Reload configuration
    #
    Configuration.current = ConfigurationBuilder.load(configuration_file)
    Configuration.current.server.start
  end
end

%w(QUIT TERM INT).each do |sig|
  trap(sig) do
    Configuration.current.logger.warn "#{sig} signal received.  Exiting."
    Configuration.current.server.stop
    exit 0
  end
end

Mauve::Server.instance.run

